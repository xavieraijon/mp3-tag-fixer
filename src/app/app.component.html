<!-- Main Container with Gradient Background -->
<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 font-sans p-6 md:p-10">

  <!-- Global Snackbar -->
  <app-snackbar></app-snackbar>

  <!-- Decorative Blobs -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-96 h-96 bg-purple-300/30 rounded-full blur-3xl"></div>
    <div class="absolute top-1/2 -left-40 w-80 h-80 bg-blue-300/30 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-40 right-1/3 w-96 h-96 bg-pink-300/30 rounded-full blur-3xl"></div>
  </div>

  <!-- Edit Modal -->
  @if (editingItem()) {
      <app-tag-editor
        [tags]="editForm()"
        [coverImageUrl]="editingItem()!.coverImageUrl"
        (save)="saveEditor($event)"
        (cancel)="closeEditor()">
      </app-tag-editor>
  }

  <div class="relative z-10 max-w-5xl mx-auto">
    <!-- Header -->
    <header class="mb-10">
      <!-- Auth Actions Bar -->
      <div class="flex justify-end mb-4">
        @if (authService.isAuthenticated()) {
          <!-- Authenticated: Show user menu -->
          <div class="relative">
            <button
              (click)="toggleUserMenu()"
              class="flex items-center gap-2 px-4 py-2 backdrop-blur-xl bg-white/40 hover:bg-white/60 rounded-xl shadow-lg border border-white/40 transition"
            >
              <lucide-icon name="user" [size]="18" class="text-indigo-600"></lucide-icon>
              <span class="font-medium text-slate-700">{{ authService.userDisplayName() }}</span>
            </button>

            @if (showUserMenu()) {
              <div class="absolute right-0 mt-2 w-48 backdrop-blur-xl bg-white/90 rounded-xl shadow-xl border border-white/40 overflow-hidden">
                <button
                  (click)="logout()"
                  class="w-full px-4 py-3 text-left hover:bg-indigo-50 transition flex items-center gap-2 text-slate-700"
                >
                  <lucide-icon name="log-out" [size]="18"></lucide-icon>
                  <span>Sign Out</span>
                </button>
              </div>
            }
          </div>
        } @else {
          <!-- Not Authenticated: Show login/register buttons -->
          <div class="flex gap-3">
            <button
              (click)="showLoginModal.set(true)"
              class="flex items-center gap-2 px-4 py-2 backdrop-blur-xl bg-white/40 hover:bg-white/60 rounded-xl shadow-lg border border-white/40 transition"
            >
              <lucide-icon name="log-in" [size]="18" class="text-indigo-600"></lucide-icon>
              <span class="font-medium text-slate-700">Sign In</span>
            </button>
            <button
              (click)="showRegisterModal.set(true)"
              class="flex items-center gap-2 px-4 py-2 backdrop-blur-xl bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg transition"
            >
              <lucide-icon name="user-plus" [size]="18"></lucide-icon>
              <span class="font-medium">Sign Up</span>
            </button>
          </div>
        }
      </div>

      <!-- Logo & Title -->
      <div class="text-center">
        <div class="inline-flex items-center justify-center p-4 backdrop-blur-xl bg-white/30 rounded-2xl mb-5 shadow-xl border border-white/40">
          <lucide-icon name="music" class="text-indigo-600 w-10 h-10"></lucide-icon>
        </div>
        <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-2 tracking-tight">
          MP3 Tag Fixer
        </h1>
        <p class="text-slate-500 font-medium">
          Auto-magic metadata with Discogs
        </p>
      </div>
    </header>

    <!-- Drop Zone -->
    <app-dropzone
        (filesDropped)="addFiles($event)"
        class="block mb-8">
    </app-dropzone>

    <!-- App Content -->
    @if (files().length > 0) {

      <app-filter-bar
        [filterText]="filterQuery"
        (filterTextChange)="filterQuery = $event"
        (processVisible)="autoProcessAll()"
        (analyzeBpmAll)="analyzeAllBpm()"
        (downloadAll)="downloadAllZip()"
        (clearList)="clearList()">
      </app-filter-bar>

      <div class="space-y-4">
        @for (item of filteredFiles(); track item.originalName; let i = $index) {
           <app-file-card
             [item]="item"
             (search)="search(item)"
             (edit)="openEditor(item)"
             (remove)="removeFile(i)"
             (download)="downloadFile(item)"
             (selectRelease)="selectRelease(item, $event)"
             (selectTrack)="selectTrack(item, $event)"
             (detectBpm)="detectBpm(item)"
             (artistChange)="updateArtist(item, $event)"
             (titleChange)="updateTitle(item, $event)">
           </app-file-card>
        }
      </div>

    }
  </div>

  <!-- Auth Modals -->
  @if (showLoginModal()) {
    <app-login
      (close)="showLoginModal.set(false)"
      (switchToRegister)="switchToRegister()">
    </app-login>
  }

  @if (showRegisterModal()) {
    <app-register
      (close)="showRegisterModal.set(false)"
      (switchToLogin)="switchToLogin()">
    </app-register>
  }
</div>
