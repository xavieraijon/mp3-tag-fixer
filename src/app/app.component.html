<!-- Main Container with Gradient Background -->
<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 font-sans p-6 md:p-10">

  <!-- Global Snackbar -->
  <app-snackbar></app-snackbar>

  <!-- Decorative Blobs -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-96 h-96 bg-purple-300/30 rounded-full blur-3xl"></div>
    <div class="absolute top-1/2 -left-40 w-80 h-80 bg-blue-300/30 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-40 right-1/3 w-96 h-96 bg-pink-300/30 rounded-full blur-3xl"></div>
  </div>

  <!-- Edit Modal -->
  @if (editingItem()) {
      <app-tag-editor
        [tags]="editForm()"
        [coverImageUrl]="editingItem()!.coverImageUrl"
        (save)="saveEditor($event)"
        (cancel)="closeEditor()">
      </app-tag-editor>
  }

  <div class="relative z-10 max-w-5xl mx-auto">

    <!-- Glass Header -->
    <header class="mb-6 backdrop-blur-xl bg-white/30 rounded-2xl border border-white/40 shadow-xl px-6 py-4">
      <div class="flex items-center justify-between">
        <!-- Left: Logo + Title -->
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl backdrop-blur-md bg-white/40 border border-white/50 flex items-center justify-center">
            <lucide-icon name="music" class="text-indigo-600 w-5 h-5"></lucide-icon>
          </div>
          <div>
            <h1 class="text-xl font-extrabold text-slate-800 tracking-tight">MP3 Tag Fixer</h1>
            <p class="text-slate-500 text-xs">Auto-magic metadata with Discogs</p>
          </div>
        </div>

        <!-- Right: Auth Buttons -->
        <div class="flex items-center gap-3">
          @if (authService.isAuthenticated()) {
            <!-- Authenticated: Show user menu -->
            <div class="relative">
              <app-button
                (click)="toggleUserMenu()"
                palette="neutral"
                variant="glass"
                icon="user"
              >
                {{ authService.userDisplayName() }}
              </app-button>

              @if (showUserMenu()) {
                <div class="absolute right-0 mt-2 w-48 backdrop-blur-xl bg-white/90 rounded-xl shadow-xl border border-white/40 overflow-hidden z-50">
                  <button
                    (click)="logout()"
                    class="w-full px-4 py-3 text-left hover:bg-indigo-50 transition flex items-center gap-2 text-slate-700 text-sm font-medium"
                  >
                    <lucide-icon name="log-out" [size]="18"></lucide-icon>
                    <span>Sign Out</span>
                  </button>
                </div>
              }
            </div>
          } @else {
            <!-- Not Authenticated: Show login/register buttons -->
            <app-button
              (click)="showLoginModal.set(true)"
              palette="neutral"
              variant="glass"
              icon="log-in"
            >
              Sign In
            </app-button>
            <app-button
              (click)="showRegisterModal.set(true)"
              palette="primary"
              variant="solid"
              icon="user-plus"
            >
              Sign Up
            </app-button>
          }
        </div>
      </div>
    </header>

    <!-- Drop Zone -->
    <app-dropzone
        (filesDropped)="addFiles($event)"
        class="block mb-4">
    </app-dropzone>

    <!-- YouTube Download Button -->
    <div class="mb-8 flex justify-center">
      <app-button
        (click)="showYoutubeModal.set(true)"
        palette="red"
        variant="glass"
        icon="youtube"
      >
        YouTube to MP3
      </app-button>
    </div>

    <!-- App Content -->
    @if (files().length > 0) {

      <app-filter-bar
        [filterText]="filterQuery"
        (filterTextChange)="filterQuery = $event"
        [aiEnabled]="aiService.enabled()"
        (aiEnabledChange)="aiService.setEnabled($event)"
        [debugMode]="store.debugMode()"
        (debugModeChange)="store.setDebugMode($event)"
        (processVisible)="autoProcessAll()"
        (analyzeBpmAll)="analyzeAllBpm()"
        (downloadAll)="downloadAllZip()"
        (clearList)="clearList()">
      </app-filter-bar>

      <div class="space-y-4">
        @for (item of filteredFiles(); track item.originalName; let i = $index) {
           <app-file-card
             [item]="item"
             (search)="search(item)"
             (edit)="openEditor(item)"
             (remove)="removeFile(i)"
             (download)="downloadFile(item)"
             (selectRelease)="selectRelease(item, $event)"
             (selectTrack)="selectTrack(item, $event)"
             (detectBpm)="detectBpm(item)"
             (artistChange)="updateArtist(item, $event)"
             (titleChange)="updateTitle(item, $event)">
           </app-file-card>
        }
      </div>

    }
  </div>

  <!-- YouTube Modal -->
  @if (showYoutubeModal()) {
    <app-youtube-modal
      (close)="showYoutubeModal.set(false)"
      (downloaded)="handleYoutubeDownload($event)">
    </app-youtube-modal>
  }

  <!-- Auth Modals -->
  @if (showLoginModal()) {
    <app-login
      (close)="showLoginModal.set(false)"
      (switchToRegister)="switchToRegister()">
    </app-login>
  }

  @if (showRegisterModal()) {
    <app-register
      (close)="showRegisterModal.set(false)"
      (switchToLogin)="switchToLogin()">
    </app-register>
  }
</div>
