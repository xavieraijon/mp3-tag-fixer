<!-- File Card -->
<div
  class="group relative bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 shadow-sm hover:shadow-md dark:shadow-slate-900/30 hover:border-slate-300 dark:hover:border-slate-600 transition-all duration-200"
>
  <!-- Remove Button -->
  <app-button
    (click)="remove.emit()"
    palette="red"
    variant="ghost"
    shape="circle"
    size="sm"
    icon="x"
    class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-all z-10 bg-white dark:bg-slate-800 shadow-md rounded-full"
    title="Remove file"
  >
  </app-button>

  <!-- Header Row: Cover/Status + Title + Info -->
  <div class="flex items-center gap-3 mb-4">
    <!-- Cover Image or Status Icon -->
    <div class="flex-shrink-0">
      @if (item().coverImageUrl) {
        <!-- Cover Image with Status Overlay -->
        <div class="relative w-12 h-12">
          <img
            [src]="item().coverImageUrl"
            alt="Cover"
            class="w-12 h-12 rounded-lg object-cover shadow-md border border-slate-200 dark:border-slate-700"
          />
          <!-- Status indicator overlay -->
          @if (item().status === 'searching' || item().status === 'loading_details' || item().isAnalyzingBpm) {
            <div class="absolute inset-0 bg-black/50 dark:bg-black/60 rounded-lg flex items-center justify-center">
              <lucide-icon name="loader-circle" class="w-5 h-5 text-white animate-spin"></lucide-icon>
            </div>
          } @else if (item().status === 'done') {
            <div
              class="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center border-2 border-white dark:border-slate-800 shadow"
            >
              <lucide-icon name="check" class="w-3 h-3 text-white"></lucide-icon>
            </div>
          } @else if (item().status === 'error') {
            <div
              class="absolute -bottom-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center border-2 border-white dark:border-slate-800 shadow"
            >
              <lucide-icon name="circle-alert" class="w-3 h-3 text-white"></lucide-icon>
            </div>
          }
        </div>
      } @else {
        <!-- Fallback: Status Icon Only -->
        <div
          class="w-10 h-10 rounded-lg flex items-center justify-center transition-all duration-200"
          [class.bg-blue-100]="item().status === 'searching' || item().status === 'loading_details'"
          [class.dark:bg-blue-900/40]="item().status === 'searching' || item().status === 'loading_details'"
          [class.text-blue-600]="item().status === 'searching' || item().status === 'loading_details'"
          [class.dark:text-blue-400]="item().status === 'searching' || item().status === 'loading_details'"
          [class.bg-emerald-100]="item().status === 'done'"
          [class.dark:bg-emerald-900/40]="item().status === 'done'"
          [class.text-emerald-600]="item().status === 'done'"
          [class.dark:text-emerald-400]="item().status === 'done'"
          [class.bg-red-100]="item().status === 'error'"
          [class.dark:bg-red-900/40]="item().status === 'error'"
          [class.text-red-600]="item().status === 'error'"
          [class.dark:text-red-400]="item().status === 'error'"
          [class.bg-purple-100]="!!item().selectedTrack && item().status !== 'done' && item().status !== 'error'"
          [class.dark:bg-purple-900/40]="!!item().selectedTrack && item().status !== 'done' && item().status !== 'error'"
          [class.text-purple-600]="!!item().selectedTrack && item().status !== 'done' && item().status !== 'error'"
          [class.dark:text-purple-400]="!!item().selectedTrack && item().status !== 'done' && item().status !== 'error'"
          [class.bg-slate-100]="item().status === 'pending' || item().status === 'ready'"
          [class.dark:bg-slate-700]="item().status === 'pending' || item().status === 'ready'"
          [class.text-slate-500]="item().status === 'pending' || item().status === 'ready'"
          [class.dark:text-slate-400]="item().status === 'pending' || item().status === 'ready'"
        >
          @if (item().status === 'searching' || item().status === 'loading_details' || item().isAnalyzingBpm) {
            <lucide-icon name="loader-circle" class="w-5 h-5 animate-spin"></lucide-icon>
          } @else if (item().status === 'done') {
            <lucide-icon name="check" class="w-5 h-5"></lucide-icon>
          } @else if (item().status === 'error') {
            <lucide-icon name="circle-alert" class="w-5 h-5"></lucide-icon>
          } @else if (!!item().selectedTrack) {
            <lucide-icon name="music" class="w-5 h-5"></lucide-icon>
          } @else {
            <lucide-icon name="file-audio" class="w-5 h-5"></lucide-icon>
          }
        </div>
      }
    </div>

    <!-- Title & Artist Info -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2">
        <h3 class="font-semibold text-slate-800 dark:text-slate-100 truncate text-sm">
          {{ item().selectedTrack?.title || item().manualTitle || item().originalName }}
        </h3>

        <!-- Source Badge (Link) -->
        @if (item().selectedRelease; as release) {
          <a
            [href]="getReleaseUrl(release)"
            target="_blank"
            rel="noopener noreferrer"
            class="flex-shrink-0 px-1.5 py-0.5 rounded text-[10px] font-bold tracking-wider hover:opacity-80 transition-opacity"
            [class.bg-purple-500]="release.source === 'musicbrainz'"
            [class.text-white]="true"
            [class.bg-slate-700]="release.source !== 'musicbrainz'"
            [class.dark:bg-slate-600]="release.source !== 'musicbrainz'"
            [title]="release.source === 'musicbrainz' ? 'View on MusicBrainz' : 'View on Discogs'"
          >
            {{ release.source === 'musicbrainz' ? 'MB' : 'DC' }}
          </a>
        }

        <!-- Info Tooltip -->
        <div class="group/info relative">
          <lucide-icon
            name="info"
            class="w-3.5 h-3.5 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 cursor-help"
          ></lucide-icon>
          <div
            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-xs rounded-lg shadow-lg opacity-0 invisible group-hover/info:opacity-100 group-hover/info:visible transition-all duration-200 whitespace-nowrap z-[60]"
          >
            <span class="text-slate-400 dark:text-slate-500 block text-[10px] uppercase tracking-wider mb-0.5"
              >Original</span
            >
            <span class="text-slate-700 dark:text-slate-200 font-medium">{{ item().originalName }}</span>
          </div>
        </div>
      </div>
      <p class="text-slate-500 dark:text-slate-400 text-xs truncate">
        {{ item().selectedRelease?.artist || item().manualArtist || 'Unknown Artist' }}
        @if (item().selectedRelease) {
          <span class="text-slate-400 dark:text-slate-500"> Â· {{ item().selectedRelease!.title }}</span>
        }
      </p>
    </div>

    <!-- Status Badge -->
    @if (item().statusMessage) {
      <div
        class="hidden sm:flex flex-shrink-0 px-2.5 py-1 rounded-full text-xs font-medium"
        [class.bg-blue-100]="item().status === 'searching' || item().status === 'loading_details'"
        [class.dark:bg-blue-900/40]="item().status === 'searching' || item().status === 'loading_details'"
        [class.text-blue-700]="item().status === 'searching' || item().status === 'loading_details'"
        [class.dark:text-blue-300]="item().status === 'searching' || item().status === 'loading_details'"
        [class.bg-emerald-100]="item().status === 'done'"
        [class.dark:bg-emerald-900/40]="item().status === 'done'"
        [class.text-emerald-700]="item().status === 'done'"
        [class.dark:text-emerald-300]="item().status === 'done'"
        [class.bg-red-100]="item().status === 'error'"
        [class.dark:bg-red-900/40]="item().status === 'error'"
        [class.text-red-700]="item().status === 'error'"
        [class.dark:text-red-300]="item().status === 'error'"
        [class.bg-slate-100]="item().status === 'pending' || item().status === 'ready'"
        [class.dark:bg-slate-700]="item().status === 'pending' || item().status === 'ready'"
        [class.text-slate-600]="item().status === 'pending' || item().status === 'ready'"
        [class.dark:text-slate-300]="item().status === 'pending' || item().status === 'ready'"
      >
        {{ item().statusMessage }}
      </div>
    }
  </div>

  <!-- Debug Stepper (Only in Debug Mode) -->
  @if (item().debugData?.enabled && item().debugData) {
    <app-debug-stepper [data]="item().debugData!" class="block mb-4"></app-debug-stepper>
  }

  <!-- Controls Row -->
  <div class="flex flex-wrap items-end gap-2">
    <!-- Artist Input -->
    <div class="flex-1 min-w-[100px] max-w-[160px]">
      <label class="block">
        <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1 block"
          >Artist</span
        >
        <input
          type="text"
          [value]="item().manualArtist"
          (input)="onArtistChange($any($event.target).value)"
          placeholder="Artist..."
          class="w-full px-2.5 py-1.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-slate-100 text-sm focus:outline-none focus:border-indigo-400 dark:focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all placeholder-slate-400 dark:placeholder-slate-500"
        />
      </label>
    </div>

    <!-- Title Input -->
    <div class="flex-1 min-w-[100px] max-w-[160px]">
      <label class="block">
        <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1 block"
          >Title</span
        >
        <input
          type="text"
          [value]="item().manualTitle"
          (input)="onTitleChange($any($event.target).value)"
          placeholder="Title..."
          class="w-full px-2.5 py-1.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-slate-100 text-sm focus:outline-none focus:border-indigo-400 dark:focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all placeholder-slate-400 dark:placeholder-slate-500"
        />
      </label>
    </div>

    <!-- Release Select -->
    @if (item().searchResults && item().searchResults.length > 0) {
      <div class="flex-1 min-w-[180px]">
        <label class="block">
          <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1 block"
            >Release</span
          >
          <select
            [ngModel]="getSelectedReleaseId()"
            (ngModelChange)="onReleaseSelectChange($event)"
            class="w-full px-2.5 py-1.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-slate-100 text-sm focus:outline-none focus:border-indigo-400 dark:focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all cursor-pointer"
          >
            <option value="">-- Select --</option>
            @for (release of item().searchResults; track release.source + ':' + release.id) {
              <option [ngValue]="release.id.toString()">
                {{ release.source === 'musicbrainz' ? '[MB] ' : '[DC] ' }}{{ release.artist }} - {{ release.title }}
                @if (release.year) {
                  ({{ release.year }})
                }
              </option>
            }
          </select>
        </label>
      </div>
    }

    <!-- AI CTA when error -->
    @if (item().status === 'error' && !aiEnabled()) {
      <div class="w-full flex justify-center mt-2 mb-1">
        <app-button
          (click)="retryWithAi.emit()"
          palette="purple"
          variant="solid"
          size="sm"
          icon="sparkles"
          title="Try deep scanning with AI"
        >
          Auto-Fix with AI
        </app-button>
      </div>
    }

    <!-- Track Select -->
    @if (item().tracks && item().tracks.length > 0) {
      <div class="flex-1 min-w-[160px]">
        <label class="block">
          <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1 block"
            >Track ({{ getRealTracks(item().tracks).length }})</span
          >
          <select
            [ngModel]="item().selectedTrack?.position || ''"
            (ngModelChange)="onTrackSelectChange($event)"
            class="w-full px-2.5 py-1.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-800 dark:text-slate-100 text-sm focus:outline-none focus:border-purple-400 dark:focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all cursor-pointer"
          >
            <option value="">-- Select --</option>
            @for (track of item().tracks; track track.position + track.title) {
              @if (track.type_ === 'track') {
                <option [ngValue]="track.position">
                  {{ track.position }}. {{ track.title }}
                  @if (track.duration) {
                    ({{ track.duration }})
                  }
                </option>
              }
            }
          </select>
        </label>
      </div>
    }

    <!-- Action Buttons -->
    <div class="flex items-center gap-1.5">
      <!-- Magic Wand (AI Force) -->
      @if (!aiEnabled()) {
        <app-button
          (click)="retryWithAi.emit()"
          palette="purple"
          variant="glass"
          shape="square"
          size="sm"
          icon="sparkles"
          title="Deep Scan with AI"
        >
        </app-button>
      }

      <!-- Search Button -->
      <app-button
        (click)="requestSearch.emit()"
        [disabled]="item().status === 'searching'"
        palette="blue"
        variant="glass"
        shape="square"
        size="sm"
        icon="search"
        title="Search Discogs"
      >
      </app-button>

      <!-- BPM Button -->
      <app-button
        (click)="detectBpm.emit()"
        [disabled]="!!item().isAnalyzingBpm"
        palette="emerald"
        variant="glass"
        size="sm"
        icon="activity"
        title="Detect BPM"
      >
        {{ getEffectiveBpm() }}
      </app-button>

      <!-- Edit Button -->
      <app-button
        (click)="edit.emit()"
        palette="neutral"
        variant="glass"
        shape="square"
        size="sm"
        icon="pencil"
        title="Edit Tags"
      >
      </app-button>

      <!-- Download Button -->
      @if (item().selectedTrack && item().status !== 'done') {
        <app-button
          (click)="download.emit()"
          palette="primary"
          variant="solid"
          size="sm"
          icon="download"
          title="Download with tags"
        >
          Download
        </app-button>
      }
    </div>
  </div>
</div>
